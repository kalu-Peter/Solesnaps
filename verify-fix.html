<!DOCTYPE html>
<html>
<head>
    <title>Verify User ID Fix</title>
</head>
<body>
    <h1>Verify User ID Fix</h1>
    <p>Open browser console (F12) to see verification results.</p>
    <button onclick="runVerification()">Verify Fix</button>
    
    <script type="module">
        window.runVerification = async function() {
            console.log('ðŸ” VERIFYING USER ID FIX');
            console.log('Checking if auth context uses correct users.id for orders lookup...');
            
            try {
                // Import supabase
                const { supabase } = await import('./src/lib/supabase.js');
                
                if (!supabase) {
                    console.error('âŒ Supabase client not available');
                    return;
                }

                // Get current auth user
                const authUserStr = localStorage.getItem('auth_user');
                if (!authUserStr) {
                    console.error('âŒ No authenticated user found');
                    return;
                }

                const authUser = JSON.parse(authUserStr);
                console.log('ðŸ“± Auth user from localStorage:', authUser);
                
                // Check if this user exists in database
                const { data: userInDb, error: userError } = await supabase
                    .from('users')
                    .select('id, auth_id, email, first_name, last_name')
                    .eq('id', authUser.id)
                    .single();
                
                if (userError) {
                    console.error('âŒ User not found in database with ID:', authUser.id);
                    console.error('Error:', userError);
                    
                    // Suggest running the fix
                    console.log('ðŸ’¡ Try running the quick fix script:');
                    console.log('   await import("./quick-fix-user-id.js")');
                    return;
                }
                
                console.log('âœ… User found in database:', userInDb);
                
                // Check if this user has orders
                const { data: orders, error: ordersError } = await supabase
                    .from('orders')
                    .select('id, user_id, order_number, status, total_amount, created_at')
                    .eq('user_id', authUser.id);
                
                if (ordersError) {
                    console.error('âŒ Error fetching orders:', ordersError);
                    return;
                }
                
                console.log(`ðŸ“¦ Orders found: ${orders?.length || 0}`);
                
                if (orders && orders.length > 0) {
                    console.log('âœ… SUCCESS! User ID fix is working correctly.');
                    console.log('ðŸ“‹ Order details:', orders);
                    
                    // Verify the user_id matches
                    const allUserIdsMatch = orders.every(order => order.user_id === authUser.id);
                    if (allUserIdsMatch) {
                        console.log('âœ… All order user_ids match auth user ID correctly');
                    } else {
                        console.warn('âš ï¸ Some orders have different user_ids');
                    }
                } else {
                    console.log('â„¹ï¸ No orders found for this user (they may not have placed any orders yet)');
                }
                
                // Also check the relationship is correct
                console.log('\nðŸ”— Verifying ID relationships:');
                console.log(`Auth user ID: ${authUser.id}`);
                console.log(`Database user ID: ${userInDb.id}`);
                console.log(`Database auth_id: ${userInDb.auth_id}`);
                
                if (authUser.id === userInDb.id) {
                    console.log('âœ… Auth user ID matches database user.id (CORRECT)');
                } else {
                    console.warn('âš ï¸ ID mismatch detected');
                }
                
            } catch (error) {
                console.error('ðŸ’¥ Verification error:', error);
            }
        };
        
        // Auto-run verification
        setTimeout(() => {
            if (window.runVerification) {
                window.runVerification();
            }
        }, 1000);
    </script>
</body>
</html>