<!DOCTYPE html>
<html>
<head>
    <title>Verify User ID Fix</title>
</head>
<body>
    <h1>Verify User ID Fix</h1>
    <p>Open browser console (F12) to see verification results.</p>
    <button onclick="runVerification()">Verify Fix</button>
    
    <script type="module">
        window.runVerification = async function() {
            console.log('🔍 VERIFYING USER ID FIX');
            console.log('Checking if auth context uses correct users.id for orders lookup...');
            
            try {
                // Import supabase
                const { supabase } = await import('./src/lib/supabase.js');
                
                if (!supabase) {
                    console.error('❌ Supabase client not available');
                    return;
                }

                // Get current auth user
                const authUserStr = localStorage.getItem('auth_user');
                if (!authUserStr) {
                    console.error('❌ No authenticated user found');
                    return;
                }

                const authUser = JSON.parse(authUserStr);
                console.log('📱 Auth user from localStorage:', authUser);
                
                // Check if this user exists in database
                const { data: userInDb, error: userError } = await supabase
                    .from('users')
                    .select('id, auth_id, email, first_name, last_name')
                    .eq('id', authUser.id)
                    .single();
                
                if (userError) {
                    console.error('❌ User not found in database with ID:', authUser.id);
                    console.error('Error:', userError);
                    
                    // Suggest running the fix
                    console.log('💡 Try running the quick fix script:');
                    console.log('   await import("./quick-fix-user-id.js")');
                    return;
                }
                
                console.log('✅ User found in database:', userInDb);
                
                // Check if this user has orders
                const { data: orders, error: ordersError } = await supabase
                    .from('orders')
                    .select('id, user_id, order_number, status, total_amount, created_at')
                    .eq('user_id', authUser.id);
                
                if (ordersError) {
                    console.error('❌ Error fetching orders:', ordersError);
                    return;
                }
                
                console.log(`📦 Orders found: ${orders?.length || 0}`);
                
                if (orders && orders.length > 0) {
                    console.log('✅ SUCCESS! User ID fix is working correctly.');
                    console.log('📋 Order details:', orders);
                    
                    // Verify the user_id matches
                    const allUserIdsMatch = orders.every(order => order.user_id === authUser.id);
                    if (allUserIdsMatch) {
                        console.log('✅ All order user_ids match auth user ID correctly');
                    } else {
                        console.warn('⚠️ Some orders have different user_ids');
                    }
                } else {
                    console.log('ℹ️ No orders found for this user (they may not have placed any orders yet)');
                }
                
                // Also check the relationship is correct
                console.log('\n🔗 Verifying ID relationships:');
                console.log(`Auth user ID: ${authUser.id}`);
                console.log(`Database user ID: ${userInDb.id}`);
                console.log(`Database auth_id: ${userInDb.auth_id}`);
                
                if (authUser.id === userInDb.id) {
                    console.log('✅ Auth user ID matches database user.id (CORRECT)');
                } else {
                    console.warn('⚠️ ID mismatch detected');
                }
                
            } catch (error) {
                console.error('💥 Verification error:', error);
            }
        };
        
        // Auto-run verification
        setTimeout(() => {
            if (window.runVerification) {
                window.runVerification();
            }
        }, 1000);
    </script>
</body>
</html>